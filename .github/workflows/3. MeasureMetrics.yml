name: Enhanced Code Metrics Analysis

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  analyze:
    name: Code Metrics Analysis
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install radon lizard pylint mccabe xenon pycodestyle cognitive_complexity wily
    
    # Basic metrics with Radon
    - name: Analyze with Radon
      run: |
        echo "=== Cyclomatic Complexity ===" > metrics_report.txt
        radon cc . -a -s >> metrics_report.txt
        echo -e "\n=== Maintainability Index ===" >> metrics_report.txt
        radon mi . -s >> metrics_report.txt
        echo -e "\n=== Raw Metrics ===" >> metrics_report.txt
        radon raw . -s >> metrics_report.txt
        echo -e "\n=== Halstead Metrics ===" >> metrics_report.txt
        radon hal . -s >> metrics_report.txt
    
    # Extended metrics with Lizard
    - name: Analyze with Lizard
      run: |
        echo -e "\n=== Detailed Code Metrics ===" >> metrics_report.txt
        lizard . --CCN 10 --length 100 --arguments 5 --extension duplicate >> metrics_report.txt
    
    # Code quality metrics with Pylint
    - name: Analyze with Pylint
      run: |
        echo -e "\n=== Code Quality Metrics ===" >> metrics_report.txt
        pylint --output-format=text . || true >> metrics_report.txt
    
    # Cognitive Complexity
    - name: Analyze Cognitive Complexity
      run: |
        echo -e "\n=== Cognitive Complexity ===" >> metrics_report.txt
        cognitive_complexity . >> metrics_report.txt
    
    # Historical metrics with Wily
    - name: Analyze with Wily
      run: |
        wily build .
        echo -e "\n=== Code Evolution Metrics ===" >> metrics_report.txt
        wily report . >> metrics_report.txt
    
    # Generate detailed report in multiple formats
    - name: Generate detailed reports
      run: |
        mkdir -p metrics
        # JSON reports
        radon cc . -a -s --json > metrics/complexity.json
        radon raw . --json > metrics/raw_metrics.json
        radon hal . --json > metrics/halstead.json
        lizard . --xml > metrics/lizard_report.xml
        cp metrics_report.txt metrics/full_report.txt
    
    - name: Upload metrics results
      uses: actions/upload-artifact@v4
      with:
        name: code-metrics
        path: metrics/